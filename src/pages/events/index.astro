---
import Layout from '../../layouts/Page.astro';
import { Container } from '@components/odyssey-theme';

// Legge tutti gli eventi in ./posts/*.mdx
const all = (await Astro.glob('./posts/*.mdx')).map((p) => {
  const fm = p.frontmatter ?? {};
  const d  = fm.date ? new Date(fm.date) : null;
  return {
    url: p.url,
    title: fm.title ?? 'Untitled event',
    excerpt: fm.excerpt ?? '',
    date: d,
    location: fm.location ?? '',
    image: fm.featuredImage ?? null,
    tags: fm.tags ?? [],
  };
});

// separa Prossimi e Passati
const now = new Date();
const upcoming = all
  .filter((e) => e.date && e.date >= now)
  .sort((a,b) => (a.date?.getTime() ?? 0) - (b.date?.getTime() ?? 0));

const past = all
  .filter((e) => e.date && e.date < now)
  .sort((a,b) => (b.date?.getTime() ?? 0) - (a.date?.getTime() ?? 0));
---

<Layout title="Events | EvOCRO" description="Upcoming and past events of the EvOCRO project">
  <Container>
    <section class="hero">
      <h1>Events</h1>
      <p>Conferences, seminars, field activities, and outreach.</p>
    </section>

    <section class="list">
      <h2>Upcoming</h2>
      {upcoming.length === 0 && <p>No upcoming events.</p>}
      <ul class="grid">
        {upcoming.map((e) => (
          <li class="card">
            <a class="link" href={e.url}>
              {e.image && (
                <div class="thumb">
                  <img src={e.image} alt={e.title} loading="lazy" />
                </div>
              )}
              <div class="meta">
                {e.date && (
                  <time datetime={e.date.toISOString()}>
                    {e.date.toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: '2-digit' })}
                  </time>
                )}
                {e.location && <span class="loc">• {e.location}</span>}
              </div>
              <h3 class="title">{e.title}</h3>
              {e.excerpt && <p class="desc">{e.excerpt}</p>}
            </a>
          </li>
        ))}
      </ul>
    </section>

    <section class="list">
      <h2>Past events</h2>
      {past.length === 0 && <p>No past events yet.</p>}
      <ul class="grid">
        {past.map((e) => (
          <li class="card">
            <a class="link" href={e.url}>
              {e.image && (
                <div class="thumb">
                  <img src={e.image} alt={e.title} loading="lazy" />
                </div>
              )}
              <div class="meta">
                {e.date && (
                  <time datetime={e.date.toISOString()}>
                    {e.date.toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: '2-digit' })}
                  </time>
                )}
                {e.location && <span class="loc">• {e.location}</span>}
              </div>
              <h3 class="title">{e.title}</h3>
              {e.excerpt && <p class="desc">{e.excerpt}</p>}
            </a>
          </li>
        ))}
      </ul>
    </section>
  </Container>
</Layout>

<style>
  .hero { margin: var(--section-margin) auto; }
  .list { margin: var(--section-margin) auto; }
  .grid {
    list-style: none; margin: 0; padding: 0;
    display: grid; gap: var(--theme-grid-gap);
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
  @media (max-width: 1024px) { .grid { grid-template-columns: repeat(2,1fr); } }
  @media (max-width: 640px)  { .grid { grid-template-columns: 1fr; } }

  .card { background: var(--theme-surface-1); border-radius: var(--theme-shape-radius); overflow: hidden; }
  .link { display: block; color: inherit; text-decoration: none; height: 100%; }
  .thumb { aspect-ratio: 16/9; overflow: hidden; }
  .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .meta { display: flex; align-items: center; gap: .5rem; padding: .75rem 1rem 0; color: var(--theme-on-surface-2); }
  .title { padding: .25rem 1rem 0; margin: 0; }
  .desc { padding: .5rem 1rem 1rem; margin: 0; color: var(--theme-on-surface-2); }
</style>
